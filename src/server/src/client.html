<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Client</title>
    <style>
        video {
            width: 640px;
            height: 480px;
            background: #000;
        }
    </style>
</head>
<body>
<video id="remoteVideo" autoplay playsinline></video>
<script>
    const video = document.getElementById("remoteVideo");

    const pc = new RTCPeerConnection();

    const ws = new WebSocket("ws://localhost:3536");

    ws.addEventListener("open", () => {
        console.log("ðŸ”Œ Connected to signaling server");
    });

    ws.addEventListener("message", async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "offer") {
            console.log("ðŸ“¨ Received offer");
            await pc.setRemoteDescription({ type: "offer", sdp: msg.sdp });
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
        } else if (msg.type === "candidate") {
            pc.addIceCandidate(msg);
        }
    });

    pc.ontrack = (event) => {
        console.log("âœ… Remote track received", event.track);
        video.srcObject = event.streams[0];

        // Log video playback events
        video.onplaying = () => console.log("ðŸŽ¥ Video is playing");
        video.onloadeddata = () => console.log("ðŸ“¦ Video data loaded");
        video.oncanplay = () => console.log("âœ… Video can play");
        video.onerror = (e) => console.error("âŒ Video error", e);
        video.addEventListener("waiting", () => console.warn("â³ Video waiting"));
        video.addEventListener("stalled", () => console.warn("ðŸš§ Video stalled"));
        video.addEventListener("error", () => console.error("âŒ Video playback error", video.error));

        // Optional: log per-frame stats
        setInterval(async () => {
            const stats = await pc.getStats();
            stats.forEach(report => {
                if (report.type === "inbound-rtp" && report.kind === "video") {
                    console.log("ðŸ“Š Video stats", report);
                }
            });
        }, 2000);
    };
</script>
</body>
</html>
